<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content=" ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»¼åˆç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Socket æœåŠ¡ç«¯ä¸­ç»“åˆçº¿ç¨‹åˆ›å»ºä¸é”€æ¯ï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¸‹å‘çš„ flag åŠ¨æ€ç®¡ç†çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿çº¿ç¨‹ä¸­çš„ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜è¢«æ­£ç¡®é‡Šæ”¾ã€‚ æ–¹æ¡ˆè®¾è®¡ Socket æœåŠ¡ç«¯ï¼š\nä½¿ç”¨ socketã€bindã€listen å’Œ accept åˆ›å»º TCP æœåŠ¡ç«¯ã€‚ åœ¨ while å¾ªç¯ä¸­æŒç»­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å’Œæ¶ˆæ¯ã€‚ çº¿ç¨‹ç®¡ç†ï¼š\nå½“å®¢æˆ·ç«¯å‘é€ flag=1 æ—¶ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚ å½“å®¢æˆ·ç«¯å‘é€ flag=2 æ—¶ï¼Œé”€æ¯çº¿ç¨‹ã€‚ ä½¿ç”¨å…¨å±€å˜é‡å’Œäº’æ–¥é”ï¼ˆpthread_mutex_tï¼‰ç®¡ç†çº¿ç¨‹çŠ¶æ€ã€‚ èµ„æºé‡Šæ”¾ï¼š\nä½¿ç”¨ pthread_cleanup_push å’Œ pthread_cleanup_pop ç¡®ä¿çº¿ç¨‹é€€å‡ºæ—¶é‡Šæ”¾ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜ã€‚ çº¿ç¨‹å‡½æ•°ï¼š\nçº¿ç¨‹å‡½æ•°æ¨¡æ‹Ÿå·¥ä½œé€»è¾‘ï¼ŒæŒç»­è¿è¡Œç›´åˆ°è¢«å–æ¶ˆã€‚ å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; #include &lt;arpa/inet.h&gt; #define PORT 8080 #define BUFFER_SIZE 1024 // å…¨å±€å˜é‡ pthread_t worker_thread = 0; // å·¥ä½œçº¿ç¨‹ ID volatile int thread_running = 0; // çº¿ç¨‹è¿è¡ŒçŠ¶æ€ pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER; // äº’æ–¥é” // çº¿ç¨‹æ•°æ®ç»“æ„ä½“ typedef struct { int id; char* message; } ThreadData; // æ¸…ç†å‡½æ•° void cleanup_handler(void* arg) { ThreadData* data = (ThreadData*)arg; printf(&#34;Cleanup handler: Freeing resources for thread %d\\n&#34;, data-&gt;id); free(data-&gt;message); // é‡Šæ”¾åŠ¨æ€å†…å­˜ free(data); // é‡Šæ”¾ç»“æ„ä½“ } // çº¿ç¨‹å‡½æ•° void* thread_func(void* arg) { ThreadData* data = (ThreadData*)arg; // æ³¨å†Œæ¸…ç†å‡½æ•° pthread_cleanup_push(cleanup_handler, data); // å…è®¸çº¿ç¨‹è¢«å–æ¶ˆ pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL); pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED, NULL); printf(&#34;Thread %d: %s\\n&#34;, data-&gt;id, data-&gt;message); // æ¨¡æ‹Ÿçº¿ç¨‹å·¥ä½œ while (1) { printf(&#34;Thread %d: Working...\\n&#34;, data-&gt;id); sleep(1); // æ˜¾å¼æ£€æŸ¥å–æ¶ˆè¯·æ±‚ pthread_testcancel(); } // å¼¹å‡ºæ¸…ç†å‡½æ•°ï¼ˆä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºçº¿ç¨‹ä¼šè¢«å–æ¶ˆï¼‰ pthread_cleanup_pop(0); pthread_exit(NULL); } // åˆ›å»ºçº¿ç¨‹ void create_thread() { pthread_mutex_lock(&amp;mutex); if (!thread_running) { ThreadData* data = (ThreadData*)malloc(sizeof(ThreadData)); if (!data) { perror(&#34;malloc&#34;); exit(EXIT_FAILURE); } data-&gt;id = 1; data-&gt;message = (char*)malloc(50 * sizeof(char)); if (!data-&gt;message) { perror(&#34;malloc&#34;); free(data); exit(EXIT_FAILURE); } snprintf(data-&gt;message, 50, &#34;Hello from thread %d&#34;, data-&gt;id); int ret = pthread_create(&amp;worker_thread, NULL, thread_func, data); if (ret != 0) { perror(&#34;pthread_create&#34;); free(data-&gt;message); free(data); exit(EXIT_FAILURE); } thread_running = 1; printf(&#34;Main: Created thread %d\\n&#34;, data-&gt;id); } else { printf(&#34;Main: Thread is already running\\n&#34;); } pthread_mutex_unlock(&amp;mutex); } // é”€æ¯çº¿ç¨‹ void destroy_thread() { pthread_mutex_lock(&amp;mutex); if (thread_running) { printf(&#34;Main: Stopping thread...\\n&#34;); int ret = pthread_cancel(worker_thread); if (ret != 0) { perror(&#34;pthread_cancel&#34;); exit(EXIT_FAILURE); } // ç­‰å¾…çº¿ç¨‹é€€å‡ºå¹¶å›æ”¶èµ„æº ret = pthread_join(worker_thread, NULL); if (ret != 0) { perror(&#34;pthread_join&#34;); exit(EXIT_FAILURE); } thread_running = 0; printf(&#34;Main: Thread has exited.\\n&#34;); } else { printf(&#34;Main: No thread is running\\n&#34;); } pthread_mutex_unlock(&amp;mutex); } // ä¸»å‡½æ•° int main() { int server_fd, client_fd; struct sockaddr_in server_addr, client_addr; socklen_t client_len = sizeof(client_addr); char buffer[BUFFER_SIZE]; // åˆ›å»º Socket server_fd = socket(AF_INET, SOCK_STREAM, 0); if (server_fd &lt; 0) { perror(&#34;socket&#34;); exit(EXIT_FAILURE); } // ç»‘å®šåœ°å€å’Œç«¯å£ server_addr.sin_family = AF_INET; server_addr.sin_addr.s_addr = INADDR_ANY; server_addr.sin_port = htons(PORT); if (bind(server_fd, (struct sockaddr*)&amp;server_addr, sizeof(server_addr)) &lt; 0) { perror(&#34;bind&#34;); close(server_fd); exit(EXIT_FAILURE); } // ç›‘å¬è¿æ¥ if (listen(server_fd, 5) &lt; 0) { perror(&#34;listen&#34;); close(server_fd); exit(EXIT_FAILURE); } printf(&#34;Server is listening on port %d...\\n&#34;, PORT); // ä¸»å¾ªç¯ while (1) { // æ¥å—å®¢æˆ·ç«¯è¿æ¥ client_fd = accept(server_fd, (struct sockaddr*)&amp;client_addr, &amp;client_len); if (client_fd &lt; 0) { perror(&#34;accept&#34;); continue; } // æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ memset(buffer, 0, BUFFER_SIZE); ssize_t bytes_received = recv(client_fd, buffer, BUFFER_SIZE - 1, 0); if (bytes_received &lt; 0) { perror(&#34;recv&#34;); close(client_fd); continue; } printf(&#34;Received from client: %s\\n&#34;, buffer); // è§£æå®¢æˆ·ç«¯ flag int flag = atoi(buffer); if (flag == 1) { create_thread(); } else if (flag == 2) { destroy_thread(); } else { printf(&#34;Invalid flag: %d\\n&#34;, flag); } // å…³é—­å®¢æˆ·ç«¯è¿æ¥ close(client_fd); } // å…³é—­æœåŠ¡å™¨ Socket close(server_fd); return 0; } ä»£ç è§£æ Socket æœåŠ¡ç«¯ï¼š\n">
<title>Socket æœåŠ¡ç«¯ä¸çº¿ç¨‹ç®¡ç†çš„ç»“åˆ-Deepseek</title>

<link rel='canonical' href='https://ynhugo.github.io/p/socket-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86%E7%9A%84%E7%BB%93%E5%90%88-deepseek/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="Socket æœåŠ¡ç«¯ä¸çº¿ç¨‹ç®¡ç†çš„ç»“åˆ-Deepseek">
<meta property='og:description' content=" ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»¼åˆç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Socket æœåŠ¡ç«¯ä¸­ç»“åˆçº¿ç¨‹åˆ›å»ºä¸é”€æ¯ï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¸‹å‘çš„ flag åŠ¨æ€ç®¡ç†çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿çº¿ç¨‹ä¸­çš„ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜è¢«æ­£ç¡®é‡Šæ”¾ã€‚ æ–¹æ¡ˆè®¾è®¡ Socket æœåŠ¡ç«¯ï¼š\nä½¿ç”¨ socketã€bindã€listen å’Œ accept åˆ›å»º TCP æœåŠ¡ç«¯ã€‚ åœ¨ while å¾ªç¯ä¸­æŒç»­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å’Œæ¶ˆæ¯ã€‚ çº¿ç¨‹ç®¡ç†ï¼š\nå½“å®¢æˆ·ç«¯å‘é€ flag=1 æ—¶ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚ å½“å®¢æˆ·ç«¯å‘é€ flag=2 æ—¶ï¼Œé”€æ¯çº¿ç¨‹ã€‚ ä½¿ç”¨å…¨å±€å˜é‡å’Œäº’æ–¥é”ï¼ˆpthread_mutex_tï¼‰ç®¡ç†çº¿ç¨‹çŠ¶æ€ã€‚ èµ„æºé‡Šæ”¾ï¼š\nä½¿ç”¨ pthread_cleanup_push å’Œ pthread_cleanup_pop ç¡®ä¿çº¿ç¨‹é€€å‡ºæ—¶é‡Šæ”¾ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜ã€‚ çº¿ç¨‹å‡½æ•°ï¼š\nçº¿ç¨‹å‡½æ•°æ¨¡æ‹Ÿå·¥ä½œé€»è¾‘ï¼ŒæŒç»­è¿è¡Œç›´åˆ°è¢«å–æ¶ˆã€‚ å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; #include &lt;arpa/inet.h&gt; #define PORT 8080 #define BUFFER_SIZE 1024 // å…¨å±€å˜é‡ pthread_t worker_thread = 0; // å·¥ä½œçº¿ç¨‹ ID volatile int thread_running = 0; // çº¿ç¨‹è¿è¡ŒçŠ¶æ€ pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER; // äº’æ–¥é” // çº¿ç¨‹æ•°æ®ç»“æ„ä½“ typedef struct { int id; char* message; } ThreadData; // æ¸…ç†å‡½æ•° void cleanup_handler(void* arg) { ThreadData* data = (ThreadData*)arg; printf(&#34;Cleanup handler: Freeing resources for thread %d\\n&#34;, data-&gt;id); free(data-&gt;message); // é‡Šæ”¾åŠ¨æ€å†…å­˜ free(data); // é‡Šæ”¾ç»“æ„ä½“ } // çº¿ç¨‹å‡½æ•° void* thread_func(void* arg) { ThreadData* data = (ThreadData*)arg; // æ³¨å†Œæ¸…ç†å‡½æ•° pthread_cleanup_push(cleanup_handler, data); // å…è®¸çº¿ç¨‹è¢«å–æ¶ˆ pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL); pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED, NULL); printf(&#34;Thread %d: %s\\n&#34;, data-&gt;id, data-&gt;message); // æ¨¡æ‹Ÿçº¿ç¨‹å·¥ä½œ while (1) { printf(&#34;Thread %d: Working...\\n&#34;, data-&gt;id); sleep(1); // æ˜¾å¼æ£€æŸ¥å–æ¶ˆè¯·æ±‚ pthread_testcancel(); } // å¼¹å‡ºæ¸…ç†å‡½æ•°ï¼ˆä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºçº¿ç¨‹ä¼šè¢«å–æ¶ˆï¼‰ pthread_cleanup_pop(0); pthread_exit(NULL); } // åˆ›å»ºçº¿ç¨‹ void create_thread() { pthread_mutex_lock(&amp;mutex); if (!thread_running) { ThreadData* data = (ThreadData*)malloc(sizeof(ThreadData)); if (!data) { perror(&#34;malloc&#34;); exit(EXIT_FAILURE); } data-&gt;id = 1; data-&gt;message = (char*)malloc(50 * sizeof(char)); if (!data-&gt;message) { perror(&#34;malloc&#34;); free(data); exit(EXIT_FAILURE); } snprintf(data-&gt;message, 50, &#34;Hello from thread %d&#34;, data-&gt;id); int ret = pthread_create(&amp;worker_thread, NULL, thread_func, data); if (ret != 0) { perror(&#34;pthread_create&#34;); free(data-&gt;message); free(data); exit(EXIT_FAILURE); } thread_running = 1; printf(&#34;Main: Created thread %d\\n&#34;, data-&gt;id); } else { printf(&#34;Main: Thread is already running\\n&#34;); } pthread_mutex_unlock(&amp;mutex); } // é”€æ¯çº¿ç¨‹ void destroy_thread() { pthread_mutex_lock(&amp;mutex); if (thread_running) { printf(&#34;Main: Stopping thread...\\n&#34;); int ret = pthread_cancel(worker_thread); if (ret != 0) { perror(&#34;pthread_cancel&#34;); exit(EXIT_FAILURE); } // ç­‰å¾…çº¿ç¨‹é€€å‡ºå¹¶å›æ”¶èµ„æº ret = pthread_join(worker_thread, NULL); if (ret != 0) { perror(&#34;pthread_join&#34;); exit(EXIT_FAILURE); } thread_running = 0; printf(&#34;Main: Thread has exited.\\n&#34;); } else { printf(&#34;Main: No thread is running\\n&#34;); } pthread_mutex_unlock(&amp;mutex); } // ä¸»å‡½æ•° int main() { int server_fd, client_fd; struct sockaddr_in server_addr, client_addr; socklen_t client_len = sizeof(client_addr); char buffer[BUFFER_SIZE]; // åˆ›å»º Socket server_fd = socket(AF_INET, SOCK_STREAM, 0); if (server_fd &lt; 0) { perror(&#34;socket&#34;); exit(EXIT_FAILURE); } // ç»‘å®šåœ°å€å’Œç«¯å£ server_addr.sin_family = AF_INET; server_addr.sin_addr.s_addr = INADDR_ANY; server_addr.sin_port = htons(PORT); if (bind(server_fd, (struct sockaddr*)&amp;server_addr, sizeof(server_addr)) &lt; 0) { perror(&#34;bind&#34;); close(server_fd); exit(EXIT_FAILURE); } // ç›‘å¬è¿æ¥ if (listen(server_fd, 5) &lt; 0) { perror(&#34;listen&#34;); close(server_fd); exit(EXIT_FAILURE); } printf(&#34;Server is listening on port %d...\\n&#34;, PORT); // ä¸»å¾ªç¯ while (1) { // æ¥å—å®¢æˆ·ç«¯è¿æ¥ client_fd = accept(server_fd, (struct sockaddr*)&amp;client_addr, &amp;client_len); if (client_fd &lt; 0) { perror(&#34;accept&#34;); continue; } // æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ memset(buffer, 0, BUFFER_SIZE); ssize_t bytes_received = recv(client_fd, buffer, BUFFER_SIZE - 1, 0); if (bytes_received &lt; 0) { perror(&#34;recv&#34;); close(client_fd); continue; } printf(&#34;Received from client: %s\\n&#34;, buffer); // è§£æå®¢æˆ·ç«¯ flag int flag = atoi(buffer); if (flag == 1) { create_thread(); } else if (flag == 2) { destroy_thread(); } else { printf(&#34;Invalid flag: %d\\n&#34;, flag); } // å…³é—­å®¢æˆ·ç«¯è¿æ¥ close(client_fd); } // å…³é—­æœåŠ¡å™¨ Socket close(server_fd); return 0; } ä»£ç è§£æ Socket æœåŠ¡ç«¯ï¼š\n">
<meta property='og:url' content='https://ynhugo.github.io/p/socket-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86%E7%9A%84%E7%BB%93%E5%90%88-deepseek/'>
<meta property='og:site_name' content='ynhugo'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='socket' /><meta property='article:tag' content='pthread' /><meta property='article:tag' content='linux' /><meta property='article:tag' content='ç¨‹åºå‘˜' /><meta property='article:published_time' content='2025-03-19T11:28:06&#43;08:00'/><meta property='article:modified_time' content='2025-03-19T11:28:06&#43;08:00'/>
<meta name="twitter:title" content="Socket æœåŠ¡ç«¯ä¸çº¿ç¨‹ç®¡ç†çš„ç»“åˆ-Deepseek">
<meta name="twitter:description" content=" ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»¼åˆç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Socket æœåŠ¡ç«¯ä¸­ç»“åˆçº¿ç¨‹åˆ›å»ºä¸é”€æ¯ï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¸‹å‘çš„ flag åŠ¨æ€ç®¡ç†çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿çº¿ç¨‹ä¸­çš„ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜è¢«æ­£ç¡®é‡Šæ”¾ã€‚ æ–¹æ¡ˆè®¾è®¡ Socket æœåŠ¡ç«¯ï¼š\nä½¿ç”¨ socketã€bindã€listen å’Œ accept åˆ›å»º TCP æœåŠ¡ç«¯ã€‚ åœ¨ while å¾ªç¯ä¸­æŒç»­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å’Œæ¶ˆæ¯ã€‚ çº¿ç¨‹ç®¡ç†ï¼š\nå½“å®¢æˆ·ç«¯å‘é€ flag=1 æ—¶ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚ å½“å®¢æˆ·ç«¯å‘é€ flag=2 æ—¶ï¼Œé”€æ¯çº¿ç¨‹ã€‚ ä½¿ç”¨å…¨å±€å˜é‡å’Œäº’æ–¥é”ï¼ˆpthread_mutex_tï¼‰ç®¡ç†çº¿ç¨‹çŠ¶æ€ã€‚ èµ„æºé‡Šæ”¾ï¼š\nä½¿ç”¨ pthread_cleanup_push å’Œ pthread_cleanup_pop ç¡®ä¿çº¿ç¨‹é€€å‡ºæ—¶é‡Šæ”¾ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜ã€‚ çº¿ç¨‹å‡½æ•°ï¼š\nçº¿ç¨‹å‡½æ•°æ¨¡æ‹Ÿå·¥ä½œé€»è¾‘ï¼ŒæŒç»­è¿è¡Œç›´åˆ°è¢«å–æ¶ˆã€‚ å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; #include &lt;arpa/inet.h&gt; #define PORT 8080 #define BUFFER_SIZE 1024 // å…¨å±€å˜é‡ pthread_t worker_thread = 0; // å·¥ä½œçº¿ç¨‹ ID volatile int thread_running = 0; // çº¿ç¨‹è¿è¡ŒçŠ¶æ€ pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER; // äº’æ–¥é” // çº¿ç¨‹æ•°æ®ç»“æ„ä½“ typedef struct { int id; char* message; } ThreadData; // æ¸…ç†å‡½æ•° void cleanup_handler(void* arg) { ThreadData* data = (ThreadData*)arg; printf(&#34;Cleanup handler: Freeing resources for thread %d\\n&#34;, data-&gt;id); free(data-&gt;message); // é‡Šæ”¾åŠ¨æ€å†…å­˜ free(data); // é‡Šæ”¾ç»“æ„ä½“ } // çº¿ç¨‹å‡½æ•° void* thread_func(void* arg) { ThreadData* data = (ThreadData*)arg; // æ³¨å†Œæ¸…ç†å‡½æ•° pthread_cleanup_push(cleanup_handler, data); // å…è®¸çº¿ç¨‹è¢«å–æ¶ˆ pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL); pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED, NULL); printf(&#34;Thread %d: %s\\n&#34;, data-&gt;id, data-&gt;message); // æ¨¡æ‹Ÿçº¿ç¨‹å·¥ä½œ while (1) { printf(&#34;Thread %d: Working...\\n&#34;, data-&gt;id); sleep(1); // æ˜¾å¼æ£€æŸ¥å–æ¶ˆè¯·æ±‚ pthread_testcancel(); } // å¼¹å‡ºæ¸…ç†å‡½æ•°ï¼ˆä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºçº¿ç¨‹ä¼šè¢«å–æ¶ˆï¼‰ pthread_cleanup_pop(0); pthread_exit(NULL); } // åˆ›å»ºçº¿ç¨‹ void create_thread() { pthread_mutex_lock(&amp;mutex); if (!thread_running) { ThreadData* data = (ThreadData*)malloc(sizeof(ThreadData)); if (!data) { perror(&#34;malloc&#34;); exit(EXIT_FAILURE); } data-&gt;id = 1; data-&gt;message = (char*)malloc(50 * sizeof(char)); if (!data-&gt;message) { perror(&#34;malloc&#34;); free(data); exit(EXIT_FAILURE); } snprintf(data-&gt;message, 50, &#34;Hello from thread %d&#34;, data-&gt;id); int ret = pthread_create(&amp;worker_thread, NULL, thread_func, data); if (ret != 0) { perror(&#34;pthread_create&#34;); free(data-&gt;message); free(data); exit(EXIT_FAILURE); } thread_running = 1; printf(&#34;Main: Created thread %d\\n&#34;, data-&gt;id); } else { printf(&#34;Main: Thread is already running\\n&#34;); } pthread_mutex_unlock(&amp;mutex); } // é”€æ¯çº¿ç¨‹ void destroy_thread() { pthread_mutex_lock(&amp;mutex); if (thread_running) { printf(&#34;Main: Stopping thread...\\n&#34;); int ret = pthread_cancel(worker_thread); if (ret != 0) { perror(&#34;pthread_cancel&#34;); exit(EXIT_FAILURE); } // ç­‰å¾…çº¿ç¨‹é€€å‡ºå¹¶å›æ”¶èµ„æº ret = pthread_join(worker_thread, NULL); if (ret != 0) { perror(&#34;pthread_join&#34;); exit(EXIT_FAILURE); } thread_running = 0; printf(&#34;Main: Thread has exited.\\n&#34;); } else { printf(&#34;Main: No thread is running\\n&#34;); } pthread_mutex_unlock(&amp;mutex); } // ä¸»å‡½æ•° int main() { int server_fd, client_fd; struct sockaddr_in server_addr, client_addr; socklen_t client_len = sizeof(client_addr); char buffer[BUFFER_SIZE]; // åˆ›å»º Socket server_fd = socket(AF_INET, SOCK_STREAM, 0); if (server_fd &lt; 0) { perror(&#34;socket&#34;); exit(EXIT_FAILURE); } // ç»‘å®šåœ°å€å’Œç«¯å£ server_addr.sin_family = AF_INET; server_addr.sin_addr.s_addr = INADDR_ANY; server_addr.sin_port = htons(PORT); if (bind(server_fd, (struct sockaddr*)&amp;server_addr, sizeof(server_addr)) &lt; 0) { perror(&#34;bind&#34;); close(server_fd); exit(EXIT_FAILURE); } // ç›‘å¬è¿æ¥ if (listen(server_fd, 5) &lt; 0) { perror(&#34;listen&#34;); close(server_fd); exit(EXIT_FAILURE); } printf(&#34;Server is listening on port %d...\\n&#34;, PORT); // ä¸»å¾ªç¯ while (1) { // æ¥å—å®¢æˆ·ç«¯è¿æ¥ client_fd = accept(server_fd, (struct sockaddr*)&amp;client_addr, &amp;client_len); if (client_fd &lt; 0) { perror(&#34;accept&#34;); continue; } // æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ memset(buffer, 0, BUFFER_SIZE); ssize_t bytes_received = recv(client_fd, buffer, BUFFER_SIZE - 1, 0); if (bytes_received &lt; 0) { perror(&#34;recv&#34;); close(client_fd); continue; } printf(&#34;Received from client: %s\\n&#34;, buffer); // è§£æå®¢æˆ·ç«¯ flag int flag = atoi(buffer); if (flag == 1) { create_thread(); } else if (flag == 2) { destroy_thread(); } else { printf(&#34;Invalid flag: %d\\n&#34;, flag); } // å…³é—­å®¢æˆ·ç«¯è¿æ¥ close(client_fd); } // å…³é—­æœåŠ¡å™¨ Socket close(server_fd); return 0; } ä»£ç è§£æ Socket æœåŠ¡ç«¯ï¼š\n">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_f509edb42ecc0ebd.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">ynhugo</a></h1>
            <h2 class="site-description">ynhugo.github.io</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com'
                        target="_blank"
                        title="x"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/book/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>Book</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://ynhugo.github.io/en/" >English</option>
                                
                                    <option value="https://ynhugo.github.io/" selected>ä¸­æ–‡</option>
                                
                                    <option value="https://ynhugo.github.io/ar/" >Ø¹Ø±Ø¨ÙŠ</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
<ul>
<li><a href="#headline-1">ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»¼åˆç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Socket æœåŠ¡ç«¯ä¸­ç»“åˆçº¿ç¨‹åˆ›å»ºä¸é”€æ¯ï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¸‹å‘çš„ flag åŠ¨æ€ç®¡ç†çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿çº¿ç¨‹ä¸­çš„ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜è¢«æ­£ç¡®é‡Šæ”¾ã€‚</a>
<ul>
<li><a href="#headline-2">æ–¹æ¡ˆè®¾è®¡</a>
</li>
<li><a href="#headline-3">å®Œæ•´ä»£ç </a>
</li>
<li><a href="#headline-4">ä»£ç è§£æ</a>
</li>
<li><a href="#headline-5">æ€»ç»“</a>
</li>
</ul>
</li>
<li><a href="#headline-6">è®²ä¸€ä¸‹äº’æ–¥é”</a>
</li>
<li><a href="#headline-7">å‰è¾¹ç¤ºä¾‹ä¸ºä»€ä¹ˆåˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹éƒ½è¦åŠ é”</a>
<ul>
<li><a href="#headline-8">ä¸ºä»€ä¹ˆéœ€è¦åŠ é”ï¼Ÿ</a>
<ul>
<li><a href="#headline-9">1.1 å…±äº«èµ„æºçš„ç«äº‰</a>
</li>
<li><a href="#headline-10">1.2 æ•°æ®ä¸€è‡´æ€§</a>
</li>
</ul>
</li>
<li><a href="#headline-11">åŠ é”çš„å…·ä½“ä½œç”¨</a>
<ul>
<li><a href="#headline-12">2.1 åˆ›å»ºçº¿ç¨‹æ—¶çš„åŠ é”</a>
</li>
<li><a href="#headline-13">2.2 é”€æ¯çº¿ç¨‹æ—¶çš„åŠ é”</a>
</li>
</ul>
</li>
<li><a href="#headline-14">ä¸åŠ é”çš„åæœ</a>
<ul>
<li><a href="#headline-15">3.1 åˆ›å»ºå¤šä¸ªçº¿ç¨‹</a>
</li>
<li><a href="#headline-16">3.2 çŠ¶æ€ä¸ä¸€è‡´</a>
</li>
<li><a href="#headline-17">3.3 èµ„æºæ³„æ¼</a>
</li>
</ul>
</li>
<li><a href="#headline-18">4. åŠ é”çš„æœ€ä½³å®è·µ</a>
<ul>
<li><a href="#headline-19">æ€»ç»“</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/socket-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E7%BA%BF%E7%A8%8B%E7%AE%A1%E7%90%86%E7%9A%84%E7%BB%93%E5%90%88-deepseek/">Socket æœåŠ¡ç«¯ä¸çº¿ç¨‹ç®¡ç†çš„ç»“åˆ-Deepseek</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 19, 2025</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 6 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    
<div id="outline-container-headline-1" class="outline-2">
<h2 id="headline-1">
ä»¥ä¸‹æ˜¯ä¸€ä¸ªç»¼åˆç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ Socket æœåŠ¡ç«¯ä¸­ç»“åˆçº¿ç¨‹åˆ›å»ºä¸é”€æ¯ï¼Œæ ¹æ®å®¢æˆ·ç«¯ä¸‹å‘çš„ flag åŠ¨æ€ç®¡ç†çº¿ç¨‹ï¼Œå¹¶ç¡®ä¿çº¿ç¨‹ä¸­çš„ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜è¢«æ­£ç¡®é‡Šæ”¾ã€‚
</h2>
<div id="outline-text-headline-1" class="outline-text-2">
<div id="outline-container-headline-2" class="outline-3">
<h3 id="headline-2">
æ–¹æ¡ˆè®¾è®¡
</h3>
<div id="outline-text-headline-2" class="outline-text-3">
<ul>
<li>
<p>Socket æœåŠ¡ç«¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ socketã€bindã€listen å’Œ accept åˆ›å»º TCP æœåŠ¡ç«¯ã€‚</li>
<li>åœ¨ while å¾ªç¯ä¸­æŒç»­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å’Œæ¶ˆæ¯ã€‚</li>
</ul>
</li>
<li>
<p>çº¿ç¨‹ç®¡ç†ï¼š</p>
<ul>
<li>å½“å®¢æˆ·ç«¯å‘é€ flag=1 æ—¶ï¼Œåˆ›å»ºçº¿ç¨‹ã€‚</li>
<li>å½“å®¢æˆ·ç«¯å‘é€ flag=2 æ—¶ï¼Œé”€æ¯çº¿ç¨‹ã€‚</li>
<li>ä½¿ç”¨å…¨å±€å˜é‡å’Œäº’æ–¥é”ï¼ˆpthread_mutex_tï¼‰ç®¡ç†çº¿ç¨‹çŠ¶æ€ã€‚</li>
</ul>
</li>
<li>
<p>èµ„æºé‡Šæ”¾ï¼š</p>
<ul>
<li>ä½¿ç”¨ pthread_cleanup_push å’Œ pthread_cleanup_pop ç¡®ä¿çº¿ç¨‹é€€å‡ºæ—¶é‡Šæ”¾ç»“æ„ä½“å’ŒåŠ¨æ€å†…å­˜ã€‚</li>
</ul>
</li>
<li>
<p>çº¿ç¨‹å‡½æ•°ï¼š</p>
<ul>
<li>çº¿ç¨‹å‡½æ•°æ¨¡æ‹Ÿå·¥ä½œé€»è¾‘ï¼ŒæŒç»­è¿è¡Œç›´åˆ°è¢«å–æ¶ˆã€‚</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-3" class="outline-3">
<h3 id="headline-3">
å®Œæ•´ä»£ç 
</h3>
<div id="outline-text-headline-3" class="outline-text-3">
<div class="src src-text">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">#include &lt;stdio.h&gt;
</span></span><span class="line"><span class="cl">#include &lt;stdlib.h&gt;
</span></span><span class="line"><span class="cl">#include &lt;string.h&gt;
</span></span><span class="line"><span class="cl">#include &lt;unistd.h&gt;
</span></span><span class="line"><span class="cl">#include &lt;pthread.h&gt;
</span></span><span class="line"><span class="cl">#include &lt;arpa/inet.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">#define PORT 8080
</span></span><span class="line"><span class="cl">#define BUFFER_SIZE 1024
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// å…¨å±€å˜é‡
</span></span><span class="line"><span class="cl">pthread_t worker_thread = 0; // å·¥ä½œçº¿ç¨‹ ID
</span></span><span class="line"><span class="cl">volatile int thread_running = 0; // çº¿ç¨‹è¿è¡ŒçŠ¶æ€
</span></span><span class="line"><span class="cl">pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER; // äº’æ–¥é”
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// çº¿ç¨‹æ•°æ®ç»“æ„ä½“
</span></span><span class="line"><span class="cl">typedef struct {
</span></span><span class="line"><span class="cl">    int id;
</span></span><span class="line"><span class="cl">    char* message;
</span></span><span class="line"><span class="cl">} ThreadData;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// æ¸…ç†å‡½æ•°
</span></span><span class="line"><span class="cl">void cleanup_handler(void* arg) {
</span></span><span class="line"><span class="cl">    ThreadData* data = (ThreadData*)arg;
</span></span><span class="line"><span class="cl">    printf(&#34;Cleanup handler: Freeing resources for thread %d\n&#34;, data-&gt;id);
</span></span><span class="line"><span class="cl">    free(data-&gt;message); // é‡Šæ”¾åŠ¨æ€å†…å­˜
</span></span><span class="line"><span class="cl">    free(data);          // é‡Šæ”¾ç»“æ„ä½“
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// çº¿ç¨‹å‡½æ•°
</span></span><span class="line"><span class="cl">void* thread_func(void* arg) {
</span></span><span class="line"><span class="cl">    ThreadData* data = (ThreadData*)arg;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // æ³¨å†Œæ¸…ç†å‡½æ•°
</span></span><span class="line"><span class="cl">    pthread_cleanup_push(cleanup_handler, data);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // å…è®¸çº¿ç¨‹è¢«å–æ¶ˆ
</span></span><span class="line"><span class="cl">    pthread_setcancelstate(PTHREAD_CANCEL_ENABLE, NULL);
</span></span><span class="line"><span class="cl">    pthread_setcanceltype(PTHREAD_CANCEL_DEFERRED, NULL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    printf(&#34;Thread %d: %s\n&#34;, data-&gt;id, data-&gt;message);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // æ¨¡æ‹Ÿçº¿ç¨‹å·¥ä½œ
</span></span><span class="line"><span class="cl">    while (1) {
</span></span><span class="line"><span class="cl">        printf(&#34;Thread %d: Working...\n&#34;, data-&gt;id);
</span></span><span class="line"><span class="cl">        sleep(1);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // æ˜¾å¼æ£€æŸ¥å–æ¶ˆè¯·æ±‚
</span></span><span class="line"><span class="cl">        pthread_testcancel();
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // å¼¹å‡ºæ¸…ç†å‡½æ•°ï¼ˆä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºçº¿ç¨‹ä¼šè¢«å–æ¶ˆï¼‰
</span></span><span class="line"><span class="cl">    pthread_cleanup_pop(0);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    pthread_exit(NULL);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// åˆ›å»ºçº¿ç¨‹
</span></span><span class="line"><span class="cl">void create_thread() {
</span></span><span class="line"><span class="cl">    pthread_mutex_lock(&amp;mutex);
</span></span><span class="line"><span class="cl">    if (!thread_running) {
</span></span><span class="line"><span class="cl">        ThreadData* data = (ThreadData*)malloc(sizeof(ThreadData));
</span></span><span class="line"><span class="cl">        if (!data) {
</span></span><span class="line"><span class="cl">            perror(&#34;malloc&#34;);
</span></span><span class="line"><span class="cl">            exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        data-&gt;id = 1;
</span></span><span class="line"><span class="cl">        data-&gt;message = (char*)malloc(50 * sizeof(char));
</span></span><span class="line"><span class="cl">        if (!data-&gt;message) {
</span></span><span class="line"><span class="cl">            perror(&#34;malloc&#34;);
</span></span><span class="line"><span class="cl">            free(data);
</span></span><span class="line"><span class="cl">            exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">        snprintf(data-&gt;message, 50, &#34;Hello from thread %d&#34;, data-&gt;id);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        int ret = pthread_create(&amp;worker_thread, NULL, thread_func, data);
</span></span><span class="line"><span class="cl">        if (ret != 0) {
</span></span><span class="line"><span class="cl">            perror(&#34;pthread_create&#34;);
</span></span><span class="line"><span class="cl">            free(data-&gt;message);
</span></span><span class="line"><span class="cl">            free(data);
</span></span><span class="line"><span class="cl">            exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        thread_running = 1;
</span></span><span class="line"><span class="cl">        printf(&#34;Main: Created thread %d\n&#34;, data-&gt;id);
</span></span><span class="line"><span class="cl">    } else {
</span></span><span class="line"><span class="cl">        printf(&#34;Main: Thread is already running\n&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    pthread_mutex_unlock(&amp;mutex);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// é”€æ¯çº¿ç¨‹
</span></span><span class="line"><span class="cl">void destroy_thread() {
</span></span><span class="line"><span class="cl">    pthread_mutex_lock(&amp;mutex);
</span></span><span class="line"><span class="cl">    if (thread_running) {
</span></span><span class="line"><span class="cl">        printf(&#34;Main: Stopping thread...\n&#34;);
</span></span><span class="line"><span class="cl">        int ret = pthread_cancel(worker_thread);
</span></span><span class="line"><span class="cl">        if (ret != 0) {
</span></span><span class="line"><span class="cl">            perror(&#34;pthread_cancel&#34;);
</span></span><span class="line"><span class="cl">            exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // ç­‰å¾…çº¿ç¨‹é€€å‡ºå¹¶å›æ”¶èµ„æº
</span></span><span class="line"><span class="cl">        ret = pthread_join(worker_thread, NULL);
</span></span><span class="line"><span class="cl">        if (ret != 0) {
</span></span><span class="line"><span class="cl">            perror(&#34;pthread_join&#34;);
</span></span><span class="line"><span class="cl">            exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        thread_running = 0;
</span></span><span class="line"><span class="cl">        printf(&#34;Main: Thread has exited.\n&#34;);
</span></span><span class="line"><span class="cl">    } else {
</span></span><span class="line"><span class="cl">        printf(&#34;Main: No thread is running\n&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    pthread_mutex_unlock(&amp;mutex);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// ä¸»å‡½æ•°
</span></span><span class="line"><span class="cl">int main() {
</span></span><span class="line"><span class="cl">    int server_fd, client_fd;
</span></span><span class="line"><span class="cl">    struct sockaddr_in server_addr, client_addr;
</span></span><span class="line"><span class="cl">    socklen_t client_len = sizeof(client_addr);
</span></span><span class="line"><span class="cl">    char buffer[BUFFER_SIZE];
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // åˆ›å»º Socket
</span></span><span class="line"><span class="cl">    server_fd = socket(AF_INET, SOCK_STREAM, 0);
</span></span><span class="line"><span class="cl">    if (server_fd &lt; 0) {
</span></span><span class="line"><span class="cl">        perror(&#34;socket&#34;);
</span></span><span class="line"><span class="cl">        exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // ç»‘å®šåœ°å€å’Œç«¯å£
</span></span><span class="line"><span class="cl">    server_addr.sin_family = AF_INET;
</span></span><span class="line"><span class="cl">    server_addr.sin_addr.s_addr = INADDR_ANY;
</span></span><span class="line"><span class="cl">    server_addr.sin_port = htons(PORT);
</span></span><span class="line"><span class="cl">    if (bind(server_fd, (struct sockaddr*)&amp;server_addr, sizeof(server_addr)) &lt; 0) {
</span></span><span class="line"><span class="cl">        perror(&#34;bind&#34;);
</span></span><span class="line"><span class="cl">        close(server_fd);
</span></span><span class="line"><span class="cl">        exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // ç›‘å¬è¿æ¥
</span></span><span class="line"><span class="cl">    if (listen(server_fd, 5) &lt; 0) {
</span></span><span class="line"><span class="cl">        perror(&#34;listen&#34;);
</span></span><span class="line"><span class="cl">        close(server_fd);
</span></span><span class="line"><span class="cl">        exit(EXIT_FAILURE);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    printf(&#34;Server is listening on port %d...\n&#34;, PORT);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // ä¸»å¾ªç¯
</span></span><span class="line"><span class="cl">    while (1) {
</span></span><span class="line"><span class="cl">        // æ¥å—å®¢æˆ·ç«¯è¿æ¥
</span></span><span class="line"><span class="cl">        client_fd = accept(server_fd, (struct sockaddr*)&amp;client_addr, &amp;client_len);
</span></span><span class="line"><span class="cl">        if (client_fd &lt; 0) {
</span></span><span class="line"><span class="cl">            perror(&#34;accept&#34;);
</span></span><span class="line"><span class="cl">            continue;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯
</span></span><span class="line"><span class="cl">        memset(buffer, 0, BUFFER_SIZE);
</span></span><span class="line"><span class="cl">        ssize_t bytes_received = recv(client_fd, buffer, BUFFER_SIZE - 1, 0);
</span></span><span class="line"><span class="cl">        if (bytes_received &lt; 0) {
</span></span><span class="line"><span class="cl">            perror(&#34;recv&#34;);
</span></span><span class="line"><span class="cl">            close(client_fd);
</span></span><span class="line"><span class="cl">            continue;
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        printf(&#34;Received from client: %s\n&#34;, buffer);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // è§£æå®¢æˆ·ç«¯ flag
</span></span><span class="line"><span class="cl">        int flag = atoi(buffer);
</span></span><span class="line"><span class="cl">        if (flag == 1) {
</span></span><span class="line"><span class="cl">            create_thread();
</span></span><span class="line"><span class="cl">        } else if (flag == 2) {
</span></span><span class="line"><span class="cl">            destroy_thread();
</span></span><span class="line"><span class="cl">        } else {
</span></span><span class="line"><span class="cl">            printf(&#34;Invalid flag: %d\n&#34;, flag);
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // å…³é—­å®¢æˆ·ç«¯è¿æ¥
</span></span><span class="line"><span class="cl">        close(client_fd);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // å…³é—­æœåŠ¡å™¨ Socket
</span></span><span class="line"><span class="cl">    close(server_fd);
</span></span><span class="line"><span class="cl">    return 0;
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-4" class="outline-3">
<h3 id="headline-4">
ä»£ç è§£æ
</h3>
<div id="outline-text-headline-4" class="outline-text-3">
<ul>
<li>
<p>Socket æœåŠ¡ç«¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ socketã€bindã€listen å’Œ accept åˆ›å»º TCP æœåŠ¡ç«¯ã€‚</li>
<li>åœ¨ while å¾ªç¯ä¸­æŒç»­æ¥æ”¶å®¢æˆ·ç«¯è¿æ¥å’Œæ¶ˆæ¯ã€‚</li>
</ul>
</li>
<li>
<p>çº¿ç¨‹ç®¡ç†ï¼š</p>
<ul>
<li>create_threadï¼šåˆ›å»ºçº¿ç¨‹å¹¶åˆå§‹åŒ–çº¿ç¨‹æ•°æ®ã€‚</li>
<li>destroy_threadï¼šå–æ¶ˆçº¿ç¨‹å¹¶ç­‰å¾…çº¿ç¨‹é€€å‡ºã€‚</li>
</ul>
</li>
<li>
<p>èµ„æºé‡Šæ”¾ï¼š</p>
<ul>
<li>ä½¿ç”¨ pthread_cleanup_push å’Œ pthread_cleanup_pop ç¡®ä¿çº¿ç¨‹é€€å‡ºæ—¶é‡Šæ”¾èµ„æºã€‚</li>
</ul>
</li>
<li>
<p>å®¢æˆ·ç«¯æ¶ˆæ¯å¤„ç†ï¼š</p>
<ul>
<li>æ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯å¹¶è§£æ flagã€‚</li>
<li>æ ¹æ® flag çš„å€¼åˆ›å»ºæˆ–é”€æ¯çº¿ç¨‹ã€‚</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-5" class="outline-3">
<h3 id="headline-5">
æ€»ç»“
</h3>
<div id="outline-text-headline-5" class="outline-text-3">
<ul>
<li>è¯¥æ–¹æ¡ˆå®ç°äº† Socket æœåŠ¡ç«¯ä¸çº¿ç¨‹ç®¡ç†çš„ç»“åˆã€‚</li>
<li>é€šè¿‡ flag åŠ¨æ€åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ï¼Œç¡®ä¿èµ„æºè¢«æ­£ç¡®é‡Šæ”¾ã€‚</li>
<li>ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…¨å±€å˜é‡ï¼Œé¿å…ç«æ€æ¡ä»¶ã€‚</li>
<li>é€‚ç”¨äºéœ€è¦åŠ¨æ€ç®¡ç†çº¿ç¨‹çš„æœåŠ¡å™¨åœºæ™¯ã€‚</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-6" class="outline-2">
<h2 id="headline-6">
è®²ä¸€ä¸‹äº’æ–¥é”
</h2>
<div id="outline-text-headline-6" class="outline-text-2">
<p>
äº’æ–¥é”ï¼ˆMutexï¼Œå…¨ç§° Mutual Exclusion Lockï¼‰ æ˜¯ä¸€ç§ç”¨äºå¤šçº¿ç¨‹ç¼–ç¨‹çš„åŒæ­¥æœºåˆ¶ï¼Œç”¨äºä¿æŠ¤å…±äº«èµ„æºï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æˆ–ä¿®æ”¹è¿™äº›èµ„æºï¼Œä»è€Œé¿å…ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰å’Œæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ã€‚</p>
<ol>
<li>äº’æ–¥é”çš„ä½œç”¨</li>
</ol>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®æˆ–ä¿®æ”¹å…±äº«èµ„æºï¼ˆå¦‚å…¨å±€å˜é‡ã€æ–‡ä»¶ã€å†…å­˜ç­‰ï¼‰ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–ç¨‹åºè¡Œä¸ºå¼‚å¸¸ã€‚äº’æ–¥é”çš„ä½œç”¨æ˜¯ï¼š</p>
<ul>
<li>ç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚</li>
<li>å½“ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…é”é‡Šæ”¾åæ‰èƒ½è®¿é—®å…±äº«èµ„æºã€‚</li>
</ul>
<ol>
<li>äº’æ–¥é”çš„åŸºæœ¬æ“ä½œ</li>
</ol>
<p>åœ¨ POSIX çº¿ç¨‹åº“ï¼ˆpthreadï¼‰ä¸­ï¼Œäº’æ–¥é”çš„æ“ä½œåŒ…æ‹¬ï¼š</p>
<ul>
<li>
<p>åˆå§‹åŒ–äº’æ–¥é”ï¼š</p>
<ul>
<li>ä½¿ç”¨ pthread_mutex_init åˆå§‹åŒ–äº’æ–¥é”ã€‚</li>
<li>ä¹Ÿå¯ä»¥ä½¿ç”¨é™æ€åˆå§‹åŒ–ï¼špthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZERã€‚</li>
</ul>
</li>
<li>
<p>åŠ é”ï¼š</p>
<ul>
<li>ä½¿ç”¨ pthread_mutex_lock åŠ é”ã€‚å¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™å½“å‰çº¿ç¨‹ä¼šé˜»å¡ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚</li>
</ul>
</li>
<li>
<p>å°è¯•åŠ é”ï¼š</p>
<ul>
<li>ä½¿ç”¨ pthread_mutex_trylock å°è¯•åŠ é”ã€‚å¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œåˆ™ç«‹å³è¿”å›é”™è¯¯ï¼Œè€Œä¸æ˜¯é˜»å¡ã€‚</li>
</ul>
</li>
<li>
<p>è§£é”ï¼š</p>
<ul>
<li>ä½¿ç”¨ pthread_mutex_unlock é‡Šæ”¾é”ï¼Œå…è®¸å…¶ä»–çº¿ç¨‹è·å–é”ã€‚</li>
</ul>
</li>
<li>
<p>é”€æ¯äº’æ–¥é”ï¼š</p>
<ul>
<li>ä½¿ç”¨ pthread_mutex_destroy é”€æ¯äº’æ–¥é”ï¼Œé‡Šæ”¾ç›¸å…³èµ„æºã€‚</li>
</ul>
</li>
</ul>
<ol>
<li>äº’æ–¥é”çš„ä½¿ç”¨åœºæ™¯</li>
</ol>
<ul>
<li>
<p>ä¿æŠ¤å…±äº«èµ„æºï¼š</p>
<ul>
<li>ä¾‹å¦‚ï¼Œå¤šä¸ªçº¿ç¨‹éœ€è¦ä¿®æ”¹åŒä¸€ä¸ªå…¨å±€å˜é‡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨äº’æ–¥é”ç¡®ä¿çº¿ç¨‹å®‰å…¨ã€‚</li>
</ul>
</li>
<li>
<p>åŒæ­¥çº¿ç¨‹æ‰§è¡Œï¼š</p>
<ul>
<li>ä¾‹å¦‚ï¼Œç¡®ä¿æŸä¸ªæ“ä½œåœ¨æ‰€æœ‰çº¿ç¨‹å®Œæˆç‰¹å®šä»»åŠ¡åå†æ‰§è¡Œã€‚</li>
</ul>
</li>
</ul>
<ol>
<li>äº’æ–¥é”çš„ç¤ºä¾‹</li>
</ol>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«èµ„æºï¼š</p>
<div class="src src-text">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">#include &lt;stdio.h&gt;
</span></span><span class="line"><span class="cl">#include &lt;stdlib.h&gt;
</span></span><span class="line"><span class="cl">#include &lt;pthread.h&gt;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// å…±äº«èµ„æº
</span></span><span class="line"><span class="cl">int counter = 0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// äº’æ–¥é”
</span></span><span class="line"><span class="cl">pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// çº¿ç¨‹å‡½æ•°
</span></span><span class="line"><span class="cl">void* thread_func(void* arg) {
</span></span><span class="line"><span class="cl">    for (int i = 0; i &lt; 100000; i++) {
</span></span><span class="line"><span class="cl">        // åŠ é”
</span></span><span class="line"><span class="cl">        pthread_mutex_lock(&amp;mutex);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // ä¿®æ”¹å…±äº«èµ„æº
</span></span><span class="line"><span class="cl">        counter++;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        // è§£é”
</span></span><span class="line"><span class="cl">        pthread_mutex_unlock(&amp;mutex);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    return NULL;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">int main() {
</span></span><span class="line"><span class="cl">    pthread_t thread1, thread2;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹
</span></span><span class="line"><span class="cl">    pthread_create(&amp;thread1, NULL, thread_func, NULL);
</span></span><span class="line"><span class="cl">    pthread_create(&amp;thread2, NULL, thread_func, NULL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // ç­‰å¾…çº¿ç¨‹ç»“æŸ
</span></span><span class="line"><span class="cl">    pthread_join(thread1, NULL);
</span></span><span class="line"><span class="cl">    pthread_join(thread2, NULL);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // æ‰“å°æœ€ç»ˆç»“æœ
</span></span><span class="line"><span class="cl">    printf(&#34;Counter value: %d\n&#34;, counter);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    // é”€æ¯äº’æ–¥é”
</span></span><span class="line"><span class="cl">    pthread_mutex_destroy(&amp;mutex);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    return 0;
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div>
</div>
<ol>
<li>ä»£ç è§£æ</li>
</ol>
<ul>
<li>
<p>å…±äº«èµ„æºï¼š</p>
<ul>
<li>counter æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè¢«ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹ã€‚</li>
</ul>
</li>
<li>
<p>äº’æ–¥é”ä¿æŠ¤ï¼š</p>
<ul>
<li>åœ¨ä¿®æ”¹ counter ä¹‹å‰ï¼Œçº¿ç¨‹è°ƒç”¨ pthread_mutex_lock åŠ é”ã€‚</li>
<li>ä¿®æ”¹å®Œæˆåï¼Œçº¿ç¨‹è°ƒç”¨ pthread_mutex_unlock è§£é”ã€‚</li>
</ul>
</li>
<li>
<p>çº¿ç¨‹å®‰å…¨ï¼š</p>
<ul>
<li>å¦‚æœæ²¡æœ‰äº’æ–¥é”ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶ä¿®æ”¹ counterï¼Œå¯¼è‡´æœ€ç»ˆç»“æœä¸æ­£ç¡®ã€‚</li>
</ul>
<p>ä½¿ç”¨äº’æ–¥é”åï¼Œcounter çš„æœ€ç»ˆå€¼ä¸€å®šæ˜¯ 200000ã€‚</p>
</li>
</ul>
<ol>
<li>äº’æ–¥é”çš„æ³¨æ„äº‹é¡¹</li>
</ol>
<ul>
<li>
<p>é¿å…æ­»é”ï¼š</p>
<ul>
<li>æ­»é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå¯¼è‡´ç¨‹åºæ— æ³•ç»§ç»­æ‰§è¡Œã€‚</li>
<li>ä¾‹å¦‚ï¼Œçº¿ç¨‹ A æŒæœ‰é” 1 å¹¶è¯·æ±‚é” 2ï¼Œè€Œçº¿ç¨‹ B æŒæœ‰é” 2 å¹¶è¯·æ±‚é” 1ã€‚</li>
<li>è§£å†³æ–¹æ³•ï¼šæŒ‰å›ºå®šé¡ºåºåŠ é”ï¼Œæˆ–ä½¿ç”¨è¶…æ—¶æœºåˆ¶ã€‚</li>
</ul>
</li>
<li>
<p>é”çš„ç²’åº¦ï¼š</p>
<ul>
<li>é”çš„ç²’åº¦ä¸å®œè¿‡å¤§ï¼Œå¦åˆ™ä¼šé™ä½ç¨‹åºçš„å¹¶å‘æ€§èƒ½ã€‚</li>
<li>ä¾‹å¦‚ï¼Œå¦‚æœé”ä¿æŠ¤äº†æ•´ä¸ªå‡½æ•°ï¼Œè€Œå‡½æ•°ä¸­æœ‰å¤§é‡ä¸æ¶‰åŠå…±äº«èµ„æºçš„ä»£ç ï¼Œä¼šå¯¼è‡´å…¶ä»–çº¿ç¨‹é•¿æ—¶é—´ç­‰å¾…ã€‚</li>
</ul>
</li>
<li>
<p>é”çš„æ€§èƒ½å¼€é”€ï¼š</p>
<ul>
<li>åŠ é”å’Œè§£é”æ“ä½œæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ã€‚</li>
</ul>
<p>å¦‚æœå…±äº«èµ„æºçš„è®¿é—®é¢‘ç‡å¾ˆé«˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´é«˜æ•ˆçš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚è¯»å†™é”æˆ–æ— é”æ•°æ®ç»“æ„ï¼‰ã€‚</p>
</li>
</ul>
<ol>
<li>äº’æ–¥é”çš„å˜ä½“</li>
</ol>
<ul>
<li>
<p>è¯»å†™é”ï¼ˆpthread_rwlock_tï¼‰ï¼š</p>
<ul>
<li>å…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»å–å…±äº«èµ„æºï¼Œä½†åªå…è®¸ä¸€ä¸ªçº¿ç¨‹å†™å…¥ã€‚</li>
<li>é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯ã€‚</li>
</ul>
</li>
<li>
<p>è‡ªæ—‹é”ï¼ˆpthread_spinlock_tï¼‰ï¼š</p>
<ul>
<li>åœ¨åŠ é”æ—¶ï¼Œçº¿ç¨‹ä¼šå¿™ç­‰å¾…ï¼ˆbusy-waitï¼‰ï¼Œè€Œä¸æ˜¯é˜»å¡ã€‚</li>
<li>é€‚ç”¨äºé”æŒæœ‰æ—¶é—´éå¸¸çŸ­çš„åœºæ™¯ã€‚</li>
</ul>
</li>
<li>
<p>æ¡ä»¶å˜é‡ï¼ˆpthread_cond_tï¼‰ï¼š</p>
<ul>
<li>ç”¨äºçº¿ç¨‹é—´çš„æ¡ä»¶åŒæ­¥ï¼Œé€šå¸¸ä¸äº’æ–¥é”é…åˆä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<ol>
<li>æ€»ç»“</li>
</ol>
<ul>
<li>äº’æ–¥é”æ˜¯ä¿æŠ¤å…±äº«èµ„æºçš„åŸºæœ¬å·¥å…·ï¼Œå¯ä»¥é¿å…ç«æ€æ¡ä»¶å’Œæ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li>ä½¿ç”¨äº’æ–¥é”æ—¶éœ€è¦æ³¨æ„æ­»é”ã€é”ç²’åº¦å’Œæ€§èƒ½å¼€é”€ã€‚</li>
<li>åœ¨å®é™…å¼€å‘ä¸­ï¼Œåº”æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©åˆé€‚çš„åŒæ­¥æœºåˆ¶ã€‚</li>
</ul>
<p>é€šè¿‡åˆç†ä½¿ç”¨äº’æ–¥é”ï¼Œå¯ä»¥ç¼–å†™å‡ºé«˜æ•ˆä¸”çº¿ç¨‹å®‰å…¨çš„å¹¶å‘ç¨‹åºã€‚</p>
</div>
</div>
<div id="outline-container-headline-7" class="outline-2">
<h2 id="headline-7">
å‰è¾¹ç¤ºä¾‹ä¸ºä»€ä¹ˆåˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹éƒ½è¦åŠ é”
</h2>
<div id="outline-text-headline-7" class="outline-text-2">
<p>
åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹æ—¶åŠ é”æ˜¯ä¸ºäº†è§£å†³**ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰**é—®é¢˜ï¼Œç¡®ä¿å¤šä¸ªçº¿ç¨‹ä¸ä¼šåŒæ—¶ä¿®æ”¹å…±äº«èµ„æºï¼ˆå¦‚ worker_thread å’Œ thread_runningï¼‰è€Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´æˆ–ç¨‹åºè¡Œä¸ºå¼‚å¸¸ã€‚</p>
<div id="outline-container-headline-8" class="outline-3">
<h3 id="headline-8">
ä¸ºä»€ä¹ˆéœ€è¦åŠ é”ï¼Ÿ
</h3>
<div id="outline-text-headline-8" class="outline-text-3">
<div id="outline-container-headline-9" class="outline-4">
<h4 id="headline-9">
1.1 å…±äº«èµ„æºçš„ç«äº‰
</h4>
<div id="outline-text-headline-9" class="outline-text-4">
<ul>
<li>åœ¨ç¤ºä¾‹ä¸­ï¼Œworker_thread å’Œ thread_running æ˜¯å…¨å±€å˜é‡ï¼Œè¢«å¤šä¸ªçº¿ç¨‹å…±äº«ã€‚</li>
<li>
<p>å¦‚æœæ²¡æœ‰é”ä¿æŠ¤ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ul>
<li>
<p><code class="verbatim">åˆ›å»ºçº¿ç¨‹æ—¶ï¼š</code></p>
<ul>
<li>ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶å‘é€ flag=1ï¼Œå¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ create_threadã€‚</li>
<li>å¦‚æœæ²¡æœ‰é”ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè€Œ worker_thread åªèƒ½ä¿å­˜ä¸€ä¸ªçº¿ç¨‹ IDï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ— æ³•è¢«æ­£ç¡®ç®¡ç†ã€‚</li>
</ul>
</li>
<li>
<p><code class="verbatim">é”€æ¯çº¿ç¨‹æ—¶ï¼š</code></p>
<ul>
<li>ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨é”€æ¯çº¿ç¨‹ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹å°è¯•åˆ›å»ºçº¿ç¨‹ï¼Œå¯èƒ½å¯¼è‡´ worker_thread å’Œ thread_running çš„çŠ¶æ€ä¸ä¸€è‡´ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-10" class="outline-4">
<h4 id="headline-10">
1.2 æ•°æ®ä¸€è‡´æ€§
</h4>
<div id="outline-text-headline-10" class="outline-text-4">
<ul>
<li>åŠ é”å¯ä»¥ç¡®ä¿å¯¹å…±äº«èµ„æºçš„ä¿®æ”¹æ˜¯åŸå­æ“ä½œï¼Œå³åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥ä¿®æ”¹è¿™äº›èµ„æºã€‚</li>
<li>
<p>ä¾‹å¦‚ï¼Œåœ¨ create_thread ä¸­ï¼ŒåŠ é”åå¯ä»¥ç¡®ä¿ï¼š</p>
<ul>
<li>æ£€æŸ¥ thread_running çš„çŠ¶æ€ã€‚</li>
<li>åˆ›å»ºçº¿ç¨‹å¹¶æ›´æ–° worker_thread å’Œ thread_runningã€‚</li>
<li>è¿™äº›æ“ä½œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-11" class="outline-3">
<h3 id="headline-11">
åŠ é”çš„å…·ä½“ä½œç”¨
</h3>
<div id="outline-text-headline-11" class="outline-text-3">
<div id="outline-container-headline-12" class="outline-4">
<h4 id="headline-12">
2.1 åˆ›å»ºçº¿ç¨‹æ—¶çš„åŠ é”
</h4>
<div id="outline-text-headline-12" class="outline-text-4">
<p>åœ¨ create_thread å‡½æ•°ä¸­ï¼š</p>
<div class="src src-text">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">void create_thread() {
</span></span><span class="line"><span class="cl">    pthread_mutex_lock(&amp;mutex); // åŠ é”
</span></span><span class="line"><span class="cl">    if (!thread_running) {
</span></span><span class="line"><span class="cl">        // åˆ›å»ºçº¿ç¨‹å¹¶æ›´æ–°å…±äº«èµ„æº
</span></span><span class="line"><span class="cl">        ThreadData* data = (ThreadData*)malloc(sizeof(ThreadData));
</span></span><span class="line"><span class="cl">        // ... åˆå§‹åŒ– data
</span></span><span class="line"><span class="cl">        int ret = pthread_create(&amp;worker_thread, NULL, thread_func, data);
</span></span><span class="line"><span class="cl">        // ... é”™è¯¯å¤„ç†
</span></span><span class="line"><span class="cl">        thread_running = 1; // æ›´æ–°çŠ¶æ€
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    pthread_mutex_unlock(&amp;mutex); // è§£é”
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div>
</div>
<ul>
<li>åŠ é”ï¼šç¡®ä¿åœ¨æ£€æŸ¥ thread_running å’Œåˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚</li>
<li>è§£é”ï¼šæ“ä½œå®Œæˆåé‡Šæ”¾é”ï¼Œå…è®¸å…¶ä»–çº¿ç¨‹è®¿é—®å…±äº«èµ„æºã€‚</li>
</ul>
</div>
</div>
<div id="outline-container-headline-13" class="outline-4">
<h4 id="headline-13">
2.2 é”€æ¯çº¿ç¨‹æ—¶çš„åŠ é”
</h4>
<div id="outline-text-headline-13" class="outline-text-4">
<p>åœ¨ destroy_thread å‡½æ•°ä¸­ï¼š</p>
<div class="src src-text">
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">void destroy_thread() {
</span></span><span class="line"><span class="cl">    pthread_mutex_lock(&amp;mutex); // åŠ é”
</span></span><span class="line"><span class="cl">    if (thread_running) {
</span></span><span class="line"><span class="cl">        // å–æ¶ˆçº¿ç¨‹å¹¶æ›´æ–°å…±äº«èµ„æº
</span></span><span class="line"><span class="cl">        int ret = pthread_cancel(worker_thread);
</span></span><span class="line"><span class="cl">        // ... é”™è¯¯å¤„ç†
</span></span><span class="line"><span class="cl">        ret = pthread_join(worker_thread, NULL);
</span></span><span class="line"><span class="cl">        // ... é”™è¯¯å¤„ç†
</span></span><span class="line"><span class="cl">        thread_running = 0; // æ›´æ–°çŠ¶æ€
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    pthread_mutex_unlock(&amp;mutex); // è§£é”
</span></span><span class="line"><span class="cl">}</span></span></code></pre></td></tr></table>
</div>
</div>
</div>
<ul>
<li>åŠ é”ï¼šç¡®ä¿åœ¨æ£€æŸ¥ thread_running å’Œé”€æ¯çº¿ç¨‹çš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­ã€‚</li>
<li>è§£é”ï¼šæ“ä½œå®Œæˆåé‡Šæ”¾é”ï¼Œå…è®¸å…¶ä»–çº¿ç¨‹è®¿é—®å…±äº«èµ„æºã€‚</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-14" class="outline-3">
<h3 id="headline-14">
ä¸åŠ é”çš„åæœ
</h3>
<div id="outline-text-headline-14" class="outline-text-3">
<p>
å¦‚æœä¸åŠ é”ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š</p>
<div id="outline-container-headline-15" class="outline-4">
<h4 id="headline-15">
3.1 åˆ›å»ºå¤šä¸ªçº¿ç¨‹
</h4>
<div id="outline-text-headline-15" class="outline-text-4">
<ul>
<li>ä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶å‘é€ flag=1ï¼Œå¯¼è‡´ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è°ƒç”¨ create_threadã€‚</li>
<li>ç”±äºæ²¡æœ‰é”ä¿æŠ¤ï¼Œä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶æ£€æŸ¥ thread_runningï¼Œå‘ç°å…¶ä¸º 0ï¼Œç„¶ååŒæ—¶åˆ›å»ºçº¿ç¨‹ã€‚</li>
<li>æœ€ç»ˆä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹è¿è¡Œï¼Œè€Œ worker_thread åªèƒ½ä¿å­˜ä¸€ä¸ªçº¿ç¨‹ IDï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è¢«ç®¡ç†ã€‚</li>
</ul>
</div>
</div>
<div id="outline-container-headline-16" class="outline-4">
<h4 id="headline-16">
3.2 çŠ¶æ€ä¸ä¸€è‡´
</h4>
<div id="outline-text-headline-16" class="outline-text-4">
<ul>
<li>ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨é”€æ¯çº¿ç¨‹ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹å°è¯•åˆ›å»ºçº¿ç¨‹ã€‚</li>
<li>
<p>ç”±äºæ²¡æœ‰é”ä¿æŠ¤ï¼Œå¯èƒ½ä¼šå¯¼è‡´ worker_thread å’Œ thread_running çš„çŠ¶æ€ä¸ä¸€è‡´ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>thread_running è¢«è®¾ç½®ä¸º 0ï¼Œä½† worker_thread ä»ç„¶æŒ‡å‘ä¸€ä¸ªæ— æ•ˆçš„çº¿ç¨‹ IDã€‚</li>
<li>æˆ–è€… thread_running è¢«è®¾ç½®ä¸º 1ï¼Œä½† worker_thread å°šæœªè¢«æ­£ç¡®èµ‹å€¼ã€‚</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-headline-17" class="outline-4">
<h4 id="headline-17">
3.3 èµ„æºæ³„æ¼
</h4>
<div id="outline-text-headline-17" class="outline-text-4">
<ul>
<li>å¦‚æœæ²¡æœ‰é”ä¿æŠ¤ï¼Œå¯èƒ½ä¼šå¤šæ¬¡åˆ›å»ºçº¿ç¨‹ï¼Œå¯¼è‡´èµ„æºï¼ˆå¦‚åŠ¨æ€å†…å­˜ï¼‰æ³„æ¼ã€‚</li>
<li>ä¾‹å¦‚ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶åˆ†é… ThreadData ç»“æ„ä½“ï¼Œä½†åªæœ‰æœ€åä¸€ä¸ªçº¿ç¨‹çš„ ThreadData ä¼šè¢«æ­£ç¡®é‡Šæ”¾ã€‚</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-headline-18" class="outline-3">
<h3 id="headline-18">
4. åŠ é”çš„æœ€ä½³å®è·µ
</h3>
<div id="outline-text-headline-18" class="outline-text-3">
<ul>
<li>
<p>é”çš„ç²’åº¦ï¼š</p>
<ul>
<li>é”çš„ç²’åº¦ä¸å®œè¿‡å¤§ï¼Œå¦åˆ™ä¼šé™ä½ç¨‹åºçš„å¹¶å‘æ€§èƒ½ã€‚</li>
<li>åœ¨ç¤ºä¾‹ä¸­ï¼Œé”åªä¿æŠ¤äº†å¿…è¦çš„å…±äº«èµ„æºï¼ˆworker_thread å’Œ thread_runningï¼‰ã€‚</li>
</ul>
</li>
<li>
<p>é¿å…æ­»é”ï¼š</p>
<ul>
<li>ç¡®ä¿åŠ é”å’Œè§£é”æˆå¯¹å‡ºç°ã€‚</li>
<li>åœ¨å‡½æ•°çš„æ‰€æœ‰é€€å‡ºè·¯å¾„ï¼ˆå¦‚ return æˆ–é”™è¯¯å¤„ç†ï¼‰ä¸­éƒ½è¦è§£é”ã€‚</li>
</ul>
</li>
<li>
<p>é”çš„æ€§èƒ½ï¼š</p>
<ul>
<li>åŠ é”å’Œè§£é”æ“ä½œæœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ã€‚</li>
<li>å¦‚æœå…±äº«èµ„æºçš„è®¿é—®é¢‘ç‡å¾ˆé«˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ›´é«˜æ•ˆçš„åŒæ­¥æœºåˆ¶ï¼ˆå¦‚è¯»å†™é”æˆ–æ— é”æ•°æ®ç»“æ„ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<div id="outline-container-headline-19" class="outline-4">
<h4 id="headline-19">
æ€»ç»“
</h4>
<div id="outline-text-headline-19" class="outline-text-4">
<ul>
<li>åŠ é”çš„ç›®çš„æ˜¯ä¿æŠ¤å…±äº«èµ„æºï¼Œé¿å…ç«æ€æ¡ä»¶å’Œæ•°æ®ä¸ä¸€è‡´ã€‚</li>
<li>åœ¨ç¤ºä¾‹ä¸­ï¼Œåˆ›å»ºçº¿ç¨‹å’Œé”€æ¯çº¿ç¨‹æ—¶åŠ é”ï¼Œæ˜¯ä¸ºäº†ç¡®ä¿å¯¹ worker_thread å’Œ thread_running çš„ä¿®æ”¹æ˜¯åŸå­æ“ä½œã€‚</li>
<li>å¦‚æœä¸åŠ é”ï¼Œå¯èƒ½ä¼šå¯¼è‡´å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…±äº«èµ„æºï¼Œä»è€Œå¼•å‘æ•°æ®ä¸ä¸€è‡´ã€èµ„æºæ³„æ¼æˆ–ç¨‹åºè¡Œä¸ºå¼‚å¸¸ã€‚</li>
</ul>
<p>é€šè¿‡åˆç†ä½¿ç”¨äº’æ–¥é”ï¼Œå¯ä»¥ç¼–å†™å‡ºçº¿ç¨‹å®‰å…¨çš„å¹¶å‘ç¨‹åºã€‚</p>
</div>
</div>
</div>
</div>
</div>
</div>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/socket/">Socket</a>
        
            <a href="/tags/pthread/">Pthread</a>
        
            <a href="/tags/linux/">Linux</a>
        
            <a href="/tags/%E7%A8%8B%E5%BA%8F%E5%91%98/">ç¨‹åºå‘˜</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            æœ€åæ›´æ–°äº Mar 19, 2025 11:28 &#43;0800
        </span>
    </section></footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/%E5%A6%82%E4%BD%95%E6%A0%B9%E6%8D%AEflag%E7%BB%93%E6%9D%9F%E7%BA%BF%E7%A8%8B%E5%B9%B6%E5%88%9B%E5%BB%BA%E6%96%B0%E7%BA%BF%E7%A8%8B-deepseek/">
        
        

        <div class="article-details">
            <h2 class="article-title">å¦‚ä½•æ ¹æ®flagç»“æŸçº¿ç¨‹å¹¶åˆ›å»ºæ–°çº¿ç¨‹-Deepseek</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/jq%E7%94%A8%E6%B3%95/">
        
        

        <div class="article-details">
            <h2 class="article-title">jqç”¨æ³•</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/socket%E5%9F%BA%E4%BA%8Etcp%E7%9A%84%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E4%BE%8B/">
        
        

        <div class="article-details">
            <h2 class="article-title">socketåŸºäºtcpçš„æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯å®ä¾‹</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/socket%E5%9F%BA%E4%BA%8Etcp%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%9E%E4%BE%8B/">
        
        

        <div class="article-details">
            <h2 class="article-title">socketåŸºäºtcpå®¢æˆ·ç«¯å®ä¾‹</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/socket%E5%9F%BA%E4%BA%8Etcp%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%AE%9E%E4%BE%8B/">
        
        

        <div class="article-details">
            <h2 class="article-title">socketåŸºäºtcpæœåŠ¡ç«¯å®ä¾‹</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "hugo-theme-stack" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2025 Example Person
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
